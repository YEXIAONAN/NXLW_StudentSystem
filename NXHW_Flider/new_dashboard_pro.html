<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>星火工作坊 · 学生管理面板 Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>

<style>
  :root {
    /* --- 亮色模式 (Light Mode) --- */
    --primary: #3b82f6;       
    --primary-hover: #2563eb;
    --primary-light: rgba(59, 130, 246, 0.1); 
    
    --bg-body: #f0f4f8;       
    --bg-glass: rgba(255, 255, 255, 0.75);       
    --bg-glass-sidebar: rgba(255, 255, 255, 0.85);
    --bg-dropdown: rgba(255, 255, 255, 0.95);
    
    --text-main: #1e293b;     
    --text-muted: #64748b;    
    
    --border-color: rgba(255, 255, 255, 0.6);
    --border-glass: 1px solid rgba(255, 255, 255, 0.5);
    
    --shadow-card: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
    --shadow-hover: 0 12px 40px 0 rgba(31, 38, 135, 0.15);

    --success: #10b981;       
    --warning: #f59e0b;       
    --danger: #ef4444;
    
    /* 动态背景球颜色 */
    --blob-1: #60a5fa;
    --blob-2: #a78bfa;
    --blob-3: #f472b6;
  }

  [data-theme="dark"] {
    /* --- 暗色模式 (Dark Mode) --- */
    --primary: #60a5fa;
    --primary-hover: #3b82f6;
    --primary-light: rgba(96, 165, 250, 0.15);
    
    --bg-body: #0f172a;       
    --bg-glass: rgba(30, 41, 59, 0.7);       
    --bg-glass-sidebar: rgba(15, 23, 42, 0.85);
    --bg-dropdown: rgba(30, 41, 59, 0.95);
    
    --text-main: #f1f5f9;     
    --text-muted: #94a3b8;    
    
    --border-color: rgba(255, 255, 255, 0.08);
    --border-glass: 1px solid rgba(255, 255, 255, 0.05);
    
    --shadow-card: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
    --shadow-hover: 0 12px 40px 0 rgba(0, 0, 0, 0.5);

    --blob-1: #1e40af;
    --blob-2: #5b21b6;
    --blob-3: #9d174d;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
  
  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    color: var(--text-main); font-size: 14px;
    background: var(--bg-body); min-height: 100vh;
    overflow-x: hidden;
    transition: background 0.3s ease, color 0.3s ease;
  }

  /* 动态背景光斑 */
  .bg-blobs {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; pointer-events: none;
  }
  .blob {
    position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.6;
    animation: blobBounce 10s infinite alternate cubic-bezier(0.4, 0, 0.2, 1);
  }
  .blob-1 { width: 400px; height: 400px; background: var(--blob-1); top: -100px; left: -100px; }
  .blob-2 { width: 300px; height: 300px; background: var(--blob-2); bottom: -50px; right: -50px; animation-delay: -2s; }
  .blob-3 { width: 350px; height: 350px; background: var(--blob-3); bottom: 20%; left: 20%; animation-delay: -4s; }

  @keyframes blobBounce {
    0% { transform: translate(0, 0) scale(1); }
    100% { transform: translate(30px, 50px) scale(1.1); }
  }

  /* --- Layout & Glassmorphism --- */
  .app-container { display: flex; min-height: 100vh; }
  
  /* Sidebar */
  .sidebar {
    width: 260px; 
    background: var(--bg-glass-sidebar);
    backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
    border-right: var(--border-glass);
    position: fixed; top: 0; bottom: 0; left: 0; z-index: 50;
    display: flex; flex-direction: column;
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .sidebar-brand {
    height: 70px; display: flex; align-items: center; padding: 0 24px;
    font-size: 22px; font-weight: 800; color: var(--primary);
    letter-spacing: -0.5px;
    border-bottom: var(--border-glass);
  }
  .sidebar-brand i { margin-right: 12px; font-size: 26px; }
  
  .menu { padding: 24px 16px; flex: 1; overflow-y: auto; }
  .menu-item {
    display: flex; align-items: center; padding: 14px 16px;
    color: var(--text-muted); font-weight: 500; border-radius: 12px;
    cursor: pointer; transition: all 0.2s ease; margin-bottom: 6px;
  }
  .menu-item i { margin-right: 12px; font-size: 20px; transition: 0.2s; }
  .menu-item:hover { background: rgba(125, 125, 125, 0.1); color: var(--text-main); transform: translateX(4px); }
  .menu-item.active {
    background: var(--primary); color: #fff; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
  }
  .menu-item.active i { opacity: 1; }
  
  .sidebar-footer { padding: 24px; border-top: var(--border-glass); }

  /* Main Content */
  .main-content {
    flex: 1; margin-left: 260px; display: flex; flex-direction: column; position: relative;
  }

  /* Header */
  .header {
    height: 70px; 
    background: var(--bg-glass);
    backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
    border-bottom: var(--border-glass);
    display: flex; align-items: center; justify-content: space-between; padding: 0 32px;
    position: sticky; top: 0; z-index: 40;
  }
  .page-title { font-size: 20px; font-weight: 700; color: var(--text-main); display:flex; align-items:center; gap:10px; }
  
  .header-actions { display: flex; align-items: center; gap: 20px; }
  .icon-btn { 
    width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center;
    font-size: 20px; color: var(--text-muted); cursor: pointer; position: relative; transition: 0.2s; 
    background: transparent; border: 1px solid transparent; text-decoration: none;
  }
  .icon-btn:hover { background: rgba(125, 125, 125, 0.1); color: var(--primary); }
  .icon-btn .badge {
    position: absolute; top: 8px; right: 8px; width: 8px; height: 8px;
    background: var(--danger); border-radius: 50%; box-shadow: 0 0 0 2px var(--bg-body);
  }
  
  .user-profile { 
    display: flex; align-items: center; gap: 12px; cursor: pointer; 
    padding: 6px 12px; border-radius: 50px; transition: 0.2s;
    border: 1px solid transparent; position: relative;
  }
  .user-profile:hover { background: rgba(125, 125, 125, 0.1); border-color: var(--border-color); }
  .avatar { 
    width: 38px; height: 38px; background: linear-gradient(135deg, var(--primary), #8b5cf6); color: #fff; 
    border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; 
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  }

  /* Components: Glass Cards */
  .glass-panel {
    background: var(--bg-glass);
    backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
    border: var(--border-glass);
    box-shadow: var(--shadow-card);
    border-radius: 20px;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  /* Page Body */
  .page-wrap { padding: 32px; max-width: 1800px; margin: 0 auto; width: 100%; }

  /* Summary Cards */
  .summary-cards { display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; margin-bottom: 32px; }
  .sum-card {
    padding: 24px; display: flex; align-items: center; position: relative; overflow: hidden;
  }
  .sum-card::before {
    content: ''; position: absolute; top:0; left:0; width: 100%; height: 4px;
    background: linear-gradient(90deg, var(--primary), transparent); opacity: 0.5;
  }
  .sum-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-hover); }
  .sum-icon {
    width: 60px; height: 60px; border-radius: 16px;
    display: flex; align-items: center; justify-content: center;
    font-size: 28px; margin-right: 20px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
  }
  .sum-info h5 { color: var(--text-muted); font-weight: 500; font-size: 14px; margin-bottom: 8px; }
  .sum-info h2 { font-size: 32px; font-weight: 700; color: var(--text-main); letter-spacing: -1px; }

  /* Charts Grid */
  .charts-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; margin-bottom: 32px; }
  .span-2 { grid-column: span 2; }
  .content-card { padding: 24px; display: flex; flex-direction: column; }
  .card-title { 
    font-size: 17px; font-weight: 600; margin-bottom: 24px; color: var(--text-main); 
    display: flex; justify-content: space-between; align-items: center; 
    border-bottom: 1px dashed var(--border-color); padding-bottom: 16px;
  }
  .chart-container { width: 100%; height: 340px; }

  /* Inputs & Buttons */
  .search-row { display: flex; gap: 16px; margin-bottom: 24px; flex-wrap: wrap; align-items: center; }
  .input-group {
    display: flex; align-items: center; background: rgba(255,255,255,0.05);
    border: 1px solid var(--border-color); border-radius: 12px; padding: 10px 16px;
    flex: 1; max-width: 400px; transition: 0.2s;
  }
  .input-group:focus-within { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-light); background: var(--bg-glass); }
  .input-group i { color: var(--text-muted); margin-right: 12px; font-size: 18px; }
  .input { border: none; background: transparent; flex: 1; font-size: 14px; width: 100%; color: var(--text-main); }
  
  select.input { cursor: pointer; }

  .btn {
    padding: 10px 20px; border-radius: 12px; border: 1px solid transparent; cursor: pointer; font-weight: 600;
    transition: all 0.2s ease; display: inline-flex; align-items: center; gap: 8px; font-size: 13px;
    letter-spacing: 0.3px;
  }
  .btn:active { transform: scale(0.96); }
  .btn-primary { 
    background: linear-gradient(135deg, var(--primary), var(--primary-hover)); 
    color: #fff; box-shadow: 0 4px 12px var(--primary-light);
  }
  .btn-primary:hover { box-shadow: 0 6px 16px var(--primary-light); filter: brightness(1.1); }
  
  .btn-outline { background: transparent; border-color: var(--border-color); color: var(--text-main); }
  .btn-outline:hover { background: rgba(125, 125, 125, 0.1); border-color: var(--text-muted); }
  
  /* Tables */
  table { width: 100%; border-collapse: separate; border-spacing: 0; }
  th {
    background: rgba(125, 125, 125, 0.05); color: var(--text-muted); font-weight: 600; font-size: 12px;
    padding: 18px; text-align: left; border-bottom: 1px solid var(--border-color); text-transform: uppercase;
  }
  th:first-child { border-top-left-radius: 12px; }
  th:last-child { border-top-right-radius: 12px; }
  
  td { padding: 18px; border-bottom: 1px solid var(--border-color); color: var(--text-main); vertical-align: middle; transition: background 0.2s; }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: var(--primary-light); }

  .badge-tag { padding: 6px 12px; border-radius: 8px; font-size: 12px; font-weight: 600; display: inline-block;}
  .tag-blue { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
  .tag-green { background: rgba(16, 185, 129, 0.15); color: #10b981; }
  .tag-gray { background: rgba(148, 163, 184, 0.15); color: #94a3b8; }
  .tag-red { background: rgba(239, 68, 68, 0.15); color: #ef4444; }

  /* Notification & User Dropdown */
  .dropdown-menu {
    position: absolute; top: 75px; right: 80px; width: 340px;
    background: var(--bg-dropdown); border: 1px solid var(--border-color);
    box-shadow: 0 20px 40px -5px rgba(0, 0, 0, 0.2); border-radius: 16px; padding: 0;
    display: none; z-index: 100; overflow: hidden; backdrop-filter: blur(20px);
  }
  .dropdown-menu.show { display: block; animation: slideDown 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
  
  .user-dropdown {
    right: 32px; width: 220px;
  }

  .note-header { padding: 16px 20px; background: rgba(0,0,0,0.03); font-weight: 700; border-bottom: 1px solid var(--border-color); color: var(--text-main); }
  .note-item { padding: 16px 20px; border-bottom: 1px solid var(--border-color); font-size: 13px; cursor: pointer; transition: 0.2s; color: var(--text-main); display:block; text-decoration: none;}
  .note-item:hover { background: rgba(125, 125, 125, 0.05); color: var(--primary); }
  .note-item i { margin-right: 8px; vertical-align: middle; font-size: 16px; }

  /* Modal */
  .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 100; opacity: 0; transition: opacity 0.3s ease; }
  .modal.show { display: flex; opacity: 1; }
  .modal-box { 
    background: var(--bg-glass); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
    width: 700px; max-width: 90%; border-radius: 24px; padding: 32px; 
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); border: 1px solid var(--border-color);
    transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); 
  }
  .modal.show .modal-box { transform: scale(1); }
  .modal-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; border-bottom: 1px solid var(--border-color); padding-bottom: 16px; }
  .modal-head h3 { font-size: 18px; font-weight: 700; color: var(--text-main); }
  .close-btn { background: transparent; border: none; font-size: 24px; color: var(--text-muted); cursor: pointer; transition: 0.2s; }
  .close-btn:hover { color: var(--danger); transform: rotate(90deg); }

  /* Honor Roll Widget */
  .honor-item { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border-color); }
  .honor-item:last-child { border-bottom: none; }
  .rank-badge { width: 24px; height: 24px; border-radius: 50%; background: var(--text-muted); color: #fff; font-size: 12px; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-weight: bold; }
  .rank-1 { background: #f59e0b; box-shadow: 0 2px 8px rgba(245,158,11,0.4); }
  .rank-2 { background: #94a3b8; }
  .rank-3 { background: #b45309; }
  .honor-info { flex: 1; }
  .honor-score { font-weight: 700; color: var(--primary); }

  /* Toast Notification */
  .toast {
    position: fixed; top: 30px; left: 50%; transform: translateX(-50%) translateY(-100%);
    background: var(--text-main); color: var(--bg-body);
    padding: 12px 24px; border-radius: 50px; font-weight: 500;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 200;
    transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
    display: flex; align-items: center; gap: 10px; opacity: 0; pointer-events: none;
  }
  .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
  .toast-success { background: var(--success); color: #fff; }
  .toast-info { background: var(--primary); color: #fff; }

  /* Animations */
  @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
  .fade-in { animation: fadeIn 0.5s ease forwards; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

  /* Responsive */
  @media (max-width: 1200px) { .charts-grid, .summary-cards { grid-template-columns: repeat(2, 1fr); } .span-2 { grid-column: span 2; } }
  @media (max-width: 768px) {
    .sidebar { transform: translateX(-100%); }
    .sidebar.mobile-open { transform: translateX(0); }
    .main-content { margin-left: 0; }
    .charts-grid, .summary-cards { grid-template-columns: 1fr; }
    .span-2 { grid-column: span 1; }
    .header { padding: 0 16px; }
    .page-wrap { padding: 16px; }
    .modal-box { width: 95%; padding: 20px; }
  }
</style>
</head>
<body>

<div class="bg-blobs">
  <div class="blob blob-1"></div>
  <div class="blob blob-2"></div>
  <div class="blob blob-3"></div>
</div>

<div class="app-container">
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-brand">
      <i class="ri-code-s-slash-line"></i> 星火工作坊 
    </div>
    <div class="menu">
      <div class="menu-item active" onclick="switchView('dashboard', this, '概览仪表盘')">
        <i class="ri-dashboard-3-line"></i> 概览仪表盘
      </div>
      <div class="menu-item" onclick="switchView('studentsView', this, '学生管理')">
        <i class="ri-user-smile-line"></i> 学生管理
      </div>
      <div class="menu-item" onclick="switchView('teachersView', this, '教师管理')">
        <i class="ri-user-star-line"></i> 教师管理
      </div>
      <div class="menu-item" onclick="switchView('examsView', this, '考试安排')">
        <i class="ri-calendar-event-line"></i> 考试安排
      </div>
      <div class="menu-item" onclick="switchView('examInfoView', this, '测验详情')">
        <i class="ri-file-list-3-line"></i> 测验详情
      </div>
      <div class="menu-item" onclick="switchView('coursesView', this, '课程信息')">
        <i class="ri-book-open-line"></i> 课程信息
      </div>
    </div>
    <div class="sidebar-footer">
      <button class="btn btn-outline" style="width:100%; justify-content:center; color: var(--danger); border-color: rgba(239,68,68,0.2)" onclick="logoutSystem()">
        <i class="ri-logout-box-r-line"></i> 退出登录
      </button>
    </div>
  </aside>

  <main class="main-content">
    <header class="header">
      <div class="page-title">
        <i class="ri-menu-2-line" style="cursor:pointer; display:none" id="mobileMenuBtn" onclick="toggleSidebar()"></i>
        <span id="pageTitle">概览仪表盘</span>
      </div>

      <div class="header-actions">
        <a href="download.html" class="icon-btn" title="资源下载">
          <i class="ri-download-cloud-2-line"></i>
        </a>

        <button class="icon-btn" onclick="toggleTheme()" title="切换主题">
          <i class="ri-sun-line" id="themeIcon"></i>
        </button>
        <button class="icon-btn" onclick="toggleFullScreen()" title="全屏模式">
          <i class="ri-fullscreen-line"></i>
        </button>
        
        <div class="icon-btn" onclick="toggleNotifications()">
          <i class="ri-notification-3-line"></i>
          <span class="badge"></span>
        </div>
        
        <div class="user-profile" onclick="toggleUserDropdown(event)">
          <div class="avatar">User</div>
          <div style="display:flex; flex-direction:column; line-height:1.2; margin-left:4px">
             <span style="font-weight: 600; font-size:13px">用户 (User)</span>
             <span style="font-size:11px; color:var(--text-muted)">默认用户组</span>
          </div>
          <i class="ri-arrow-down-s-line" style="color: var(--text-muted); margin-left:8px"></i>
        </div>
      </div>
      
      <div class="dropdown-menu" id="notificationDropdown">
        <div class="note-header">消息通知</div>
        <div class="note-item">
          <div class="note-title"><i class="ri-information-fill" style="color:var(--primary)"></i> 资源下载</div>
          <div style="margin-top:4px">网络安全工具包 v2.0 已上线。</div>
          <div class="note-time" style="font-size:11px;color:var(--text-muted);margin-top:4px">10分钟前</div>
        </div>
        <div class="note-item">
          <div class="note-title"><i class="ri-alert-fill" style="color:var(--warning)"></i> 系统维护</div>
          <div style="margin-top:4px">服务器将在凌晨 02:00 进行补丁更新。</div>
          <div class="note-time" style="font-size:11px;color:var(--text-muted);margin-top:4px">2小时前</div>
        </div>
      </div>

      <div class="dropdown-menu user-dropdown" id="userDropdown">
        <div class="note-header">用户菜单</div>
        <div class="note-item" onclick="showToast('个人中心功能开发中...', 'info')">
          <i class="ri-user-settings-line"></i> 个人中心
        </div>
        <div class="note-item" onclick="window.location.href='download.html'">
          <i class="ri-download-cloud-line"></i> 资源中心
        </div>
        <div class="note-item" style="color:var(--danger)" onclick="logoutSystem()">
          <i class="ri-logout-box-r-line"></i> 退出登录
        </div>
      </div>
    </header>

    <div class="page-wrap">
      
      <div id="dashboard" class="view-section fade-in">
        <div class="summary-cards">
          <div class="sum-card glass-panel">
            <div class="sum-icon" style="background:#eff6ff;color:#2563eb"><i class="ri-group-line"></i></div>
            <div class="sum-info"><h5>在校学生</h5><h2 id="totalStudents">-</h2></div>
          </div>
          <div class="sum-card glass-panel">
            <div class="sum-icon" style="background:#ecfdf5;color:#10b981"><i class="ri-check-double-line"></i></div>
            <div class="sum-info"><h5>平均成绩</h5><h2 id="avgScore">-</h2></div>
          </div>
          <div class="sum-card glass-panel">
            <div class="sum-icon" style="background:#fef3c7;color:#d97706"><i class="ri-book-mark-line"></i></div>
            <div class="sum-info"><h5>开设课程</h5><h2 id="totalCourses">-</h2></div>
          </div>
          <div class="sum-card glass-panel">
            <div class="sum-icon" style="background:#f3e8ff;color:#7e22ce"><i class="ri-file-user-line"></i></div>
            <div class="sum-info"><h5>近期考试</h5><h2 id="totalExams">-</h2></div>
          </div>
        </div>

        <div class="charts-grid">
          <div class="content-card glass-panel">
            <div class="card-title">光荣榜 (Top 5) <i class="ri-trophy-line" style="color:var(--warning)"></i></div>
            <div id="honorList" style="overflow-y:auto; height:340px"></div>
          </div>

          <div class="content-card glass-panel span-2">
            <div class="card-title">专业人数分布 <i class="ri-radar-line" style="color:var(--text-muted)"></i></div>
            <div id="chartMajor" class="chart-container"></div>
          </div>
          
          <div class="content-card glass-panel span-2">
            <div class="card-title">学生成绩分布概览 <i class="ri-bar-chart-box-line" style="color:var(--text-muted)"></i></div>
            <div id="chartScore" class="chart-container"></div>
          </div>
          
          <div class="content-card glass-panel">
            <div class="card-title">学生男女比例 <i class="ri-pie-chart-line" style="color:var(--text-muted)"></i></div>
            <div id="chartGender" class="chart-container"></div>
          </div>

          <div class="content-card glass-panel">
            <div class="card-title">及格率仪表盘 <i class="ri-speed-mini-line" style="color:var(--text-muted)"></i></div>
            <div id="chartPassRate" class="chart-container"></div>
          </div>
           <div class="content-card glass-panel span-2">
            <div class="card-title">年龄段统计 <i class="ri-line-chart-line" style="color:var(--text-muted)"></i></div>
            <div id="chartGrade" class="chart-container"></div>
          </div>

           <div class="content-card glass-panel">
             <div class="card-title">课程状态统计 <i class="ri-donut-chart-line" style="color:var(--text-muted)"></i></div>
             <div id="chartCourseStatus" class="chart-container"></div>
          </div>

          <div class="content-card glass-panel span-2">
             <div class="card-title">教师授课量 <i class="ri-bar-chart-horizontal-line" style="color:var(--text-muted)"></i></div>
             <div id="chartTeacherLoad" class="chart-container"></div>
          </div>
        </div>
      </div>

      <div id="studentsView" class="view-section" style="display:none">
        <div class="content-card glass-panel">
          <div class="search-row">
            <div class="input-group">
              <i class="ri-search-line"></i>
              <input class="input" id="studentSearch" placeholder="搜索姓名 / 国籍..." oninput="applyStudentFilter()" />
            </div>
            <div class="input-group" style="max-width:150px">
              <select class="input" id="studentSort" onchange="applyStudentFilter()">
                <option value="default">默认排序</option>
                <option value="scoreDesc">成绩: 高到低</option>
                <option value="scoreAsc">成绩: 低到高</option>
              </select>
            </div>
             <div class="input-group" style="max-width:150px">
              <select class="input" id="studentStatus" onchange="applyStudentFilter()">
                <option value="all">所有状态</option>
                <option value="pass">及格</option>
                <option value="fail">不及格</option>
              </select>
            </div>

            <button class="btn btn-outline" onclick="resetStudentFilter()">重置</button>
            <div style="flex:1"></div>
            <button class="btn btn-outline" onclick="exportToCSV()"><i class="ri-file-excel-2-line"></i> 导出 CSV</button>
            <button class="btn btn-primary"><i class="ri-add-line"></i> 新增学生</button>
          </div>
          <table aria-describedby="学生列表">
            <thead><tr><th>姓名</th><th>国籍</th><th>专业方向</th><th>年级</th><th>最新成绩</th><th>操作</th></tr></thead>
            <tbody id="studentTable"></tbody>
          </table>
          <div style="padding:16px; text-align:right; color:var(--text-muted); font-size:12px">
            共找到 <span id="stdCount" style="font-weight:bold">0</span> 名学生
          </div>
        </div>
      </div>

      <div id="teachersView" class="view-section" style="display:none">
        <div class="content-card glass-panel">
           <div class="search-row">
            <div class="input-group"><i class="ri-search-line"></i><input class="input" id="teacherSearch" placeholder="搜索教师 / 部门..." oninput="renderTeachers()" /></div>
           </div>
           <table>
             <thead><tr><th>姓名</th><th>年龄</th><th>教授课程</th><th>所属部门</th><th>操作</th></tr></thead>
             <tbody id="teacherTable"></tbody>
           </table>
         </div>
      </div>

      <div id="examsView" class="view-section" style="display:none">
        <div class="content-card glass-panel">
           <div class="search-row">
             <div class="input-group"><i class="ri-search-line"></i><input class="input" id="examSearch" placeholder="搜索考试名称..." oninput="renderExams()" /></div>
           </div>
           <table>
             <thead><tr><th>考试名称</th><th>科目</th><th>时间</th><th>人数</th><th>监考员</th></tr></thead>
             <tbody id="examTable"></tbody>
           </table>
        </div>
      </div>

      <div id="examInfoView" class="view-section" style="display:none">
        <div class="content-card glass-panel">
           <div class="search-row">
             <div class="input-group"><i class="ri-search-line"></i><input class="input" id="examInfoSearch" placeholder="搜索课程 / 教师..." oninput="renderExamInfo()" /></div>
           </div>
           <table>
             <thead><tr><th>测验课程</th><th>测验时间</th><th>测验教师</th><th>测验人数</th><th>操作</th></tr></thead>
             <tbody id="examInfoTable"></tbody>
           </table>
        </div>
      </div>

      <div id="coursesView" class="view-section" style="display:none">
        <div class="content-card glass-panel">
           <div class="search-row">
             <div class="input-group"><i class="ri-search-line"></i><input class="input" id="courseSearch" placeholder="搜索课程 / 教师..." oninput="renderCourses()" /></div>
           </div>
           <table>
             <thead><tr><th>课程名称</th><th>开课时间</th><th>授课教师</th><th>课程状态</th><th>操作</th></tr></thead>
             <tbody id="courseTable"></tbody>
           </table>
        </div>
      </div>

    </div>
  </main>
</div>

<div id="studentModal" class="modal" onclick="modalOverlayClick(event,'studentModal')">
  <div class="modal-box" onclick="event.stopPropagation()">
    <div class="modal-head">
      <h3 id="studentModalTitle">学生详情</h3>
      <button class="close-btn" onclick="closeStudentModal()"><i class="ri-close-line"></i></button>
    </div>
    <div id="studentModalBody" style="line-height:2; color: var(--text-muted)"></div>
    <div style="margin-top:24px; text-align:right">
       <button class="btn btn-primary" onclick="closeStudentModal()">关闭</button>
    </div>
  </div>
</div>

<div id="examModal" class="modal" onclick="modalOverlayClick(event,'examModal')">
  <div class="modal-box" onclick="event.stopPropagation()">
    <div class="modal-head">
      <h3 id="examModalTitle">测验详情</h3>
      <button class="close-btn" onclick="closeExamModal()"><i class="ri-close-line"></i></button>
    </div>
    <div id="examModalBody">
      <table style="width:100%;border-collapse:collapse">
        <thead><tr style="background:rgba(125,125,125,0.05)"><th style="padding:10px">学生姓名</th><th style="padding:10px">得分</th><th style="padding:10px">评语</th></tr></thead>
        <tbody id="examModalTable"></tbody>
      </table>
    </div>
  </div>
</div>

<div id="toast" class="toast"><i class="ri-checkbox-circle-fill"></i> <span>Message</span></div>

<script>
/* ===========================
   1. DATA (Preserved)
   =========================== */
const students = [
  { id:1,name:"程语兴",cls:"中国",age:"2024年秋季学期",major:"人工智能-系统架构师",grade:"16岁",gender:"男",scores:[80],phone:"+86 13377181359",religion:"无",email:"叶小楠" },
  { id:2,name:"农秋峰",cls:"中国",age:"2024年秋季学期",major:"人工智能-系统架构师",grade:"16岁",gender:"男",scores:[85],phone:"+86 19257716750",religion:"无",email:"叶小楠" },
  { id:3,name:"黄世杰",cls:"中国",age:"2025年秋季学期",major:"人工智能-系统架构师",grade:"15岁",gender:"男",scores:[0],phone:"+86 18007816094",religion:"无",email:"叶小楠" },
  { id:4,name:"陈启添",cls:"中国",age:"2025年秋季学期",major:"人工智能-系统架构师",grade:"15岁",gender:"男",scores:[0],phone:"+86 19177144970",religion:"无",email:"叶小楠" },
  { id:5,name:"黄警威",cls:"中国",age:"2025年秋季学期",major:"人工智能-系统架构师",grade:"15岁",gender:"男",scores:[0],phone:"+86 19114909280",religion:"无",email:"叶小楠" },
  { id:6,name:"李俊昊",cls:"中国",age:"2024年秋季学期",major:"人工智能-前端开发工程师",grade:"16岁",gender:"男",scores:[87],phone:"+86 18269692812",religion:"无",email:"Hi-Tao" },
  { id:7,name:"潘润根",cls:"中国",age:"2024年秋季学期",major:"人工智能-前端开发工程师",grade:"17岁",gender:"男",scores:[66],phone:"+86 18378628085",religion:"无",email:"Hi-Tao" },
  { id:8,name:"卢裕龙",cls:"中国",age:"2024年秋季学期",major:"人工智能-前端开发工程师",grade:"16岁",gender:"男",scores:[70],phone:"+86 13978684758",religion:"无",email:"Hi-Tao" },
  { id:9,name:"杨慧琴",cls:"中国",age:"2025年秋季学期",major:"人工智能-前端开发工程师",grade:"16岁",gender:"女",scores:[41],phone:"+86 18277626623",religion:"佛教",email:"Hi-Tao" },
  { id:10,name:"凌财",cls:"中国",age:"2025年秋季学期",major:"人工智能-前端开发工程师",grade:"15岁",gender:"男",scores:[72],phone:"+86 19053540657",religion:"无",email:"Hi-Tao" },
  { id:11,name:"黄正宇",cls:"中国",age:"2024年秋季学期",major:"人工智能-机器人工程师",grade:"18岁",gender:"男",scores:[50],phone:"+86 19247755963",religion:"无",email:"Xiang" },  
  { id:12,name:"杜宇轩",cls:"中国",age:"2025年秋季学期",major:"人工智能-机器人工程师",grade:"15岁",gender:"男",scores:[40],phone:"+86 13481108219",religion:"无",email:"Xiang" },  
  { id:13,name:"赵鸿宁",cls:"中国",age:"2025年秋季学期",major:"人工智能-算法软件工程师",grade:"16岁",gender:"女",scores:[0],phone:"+86 18587779003",religion:"佛教",email:"不要@我" },
  { id:14,name:"张苏斌",cls:"中国",age:"2025年秋季学期",major:"人工智能-算法软件工程师",grade:"17岁",gender:"男",scores:[41],phone:"+86 15578871307",religion:"无",email:"不要@我" },
  { id:15,name:"李易萱",cls:"中国",age:"2025年秋季学期",major:"人工智能-算法软件工程师",grade:"15岁",gender:"女",scores:[20],phone:"+86 15994350752",religion:"基督教",email:"不要@我" },
  { id:16,name:"石成烨",cls:"中国",age:"2025年秋季学期",major:"人工智能-算法软件工程师",grade:"17岁",gender:"男",scores:[41],phone:"+86 18477713701",religion:"佛教",email:"不要@我" },
  { id:17,name:"郭星亮",cls:"印度尼西亚",age:"2025年秋季学期",major:"网络安全",grade:"16岁",gender:"男",scores:[0],phone:"+86 18587917576",religion:"天主教徒",email:"阮裕光" },
  { id:18,name:"郭成祥",cls:"印度尼西亚",age:"2025年秋季学期",major:"网络安全",grade:"18岁",gender:"男",scores:[0],phone:"+86 18577843117",religion:"Christian",email:"阮裕光" },
  { id:19,name:"邓晖煌",cls:"印度尼西亚",age:"2025年秋季学期",major:"网络安全",grade:"17岁",gender:"男",scores:[0],phone:"+86 18577829392",religion:"穆斯林",email:"阮裕光" }
];

const teachers = [
  { id:1,name:"叶小楠",years:17,course:"Linux，Java，C++，Python",dept:"303人工智能",email:"admin@example.com" },
  { id:2,name:"Hi-Tao",years:18,course:"Python，HTML",dept:"303人工智能",email:"admin@example.com" },
  { id:3,name:"Xiang",years:18,course:"Python，HTML，ROS",dept:"303人工智能",email:"admin@example.com" },
  { id:4,name:"不要@我",years:18,course:"Python",dept:"303人工智能",email:"admin@example.com" }
];

const exams = [
  { id:1,name:"人工智能 - 一组 - 一次测验",subject:"Linux基础",time:"2025-01-05",num:2,pass:"叶小楠" },
  { id:2,name:"人工智能 - 二组 - 一次测验",subject:"网页技术",time:"2025-03-12",num:5,pass:"Hi-Tao" },
  { id:3,name:"人工智能 - 三组 - 一次测验",subject:"Python 基础（机器人编程方向）",time:"2025-03-12",num:3,pass:"Xiang" },
  { id:4,name:"人工智能 - 四组 - 一次测验",subject:"Python 基础",time:"2025-03-12",num:3,pass:"Zhou" }
];

const examInfoList = [
  {
    id:1, course:"Linux基础", date:"2025-04-10", teacher:"叶小楠", count:2,
    students:[
      { name:"程语兴", score:80, comment:"继续加油！" },
      { name:"农秋峰", score:85, comment:"继续加油！" },
    ]
  },
  {
    id:2, course:"网页技术", date:"2025-03-20", teacher:"Hi-Tao", count:5,
    students:[
      { name:"李俊昊", score:87, comment:"认真审题、温故而知新" },
      { name:"潘润根", score:66, comment:"理论知识也很重要" },
      { name:"卢裕龙", score:70, comment:"打字速度理论知识要提升" },
      { name:"杨慧琴", score:41, comment:"不要气馁，继续加油" },
      { name:"凌财", score:72, comment:"Very good" },
    ]
  },
  {
    id:3, course:"Python 基础（机器人编程方向）", date:"2025-04-10", teacher:"Xiang", count:3,
    students:[
      { name:"黄正宇", score:50, comment:"及格，再接再厉！" },
      { name:"杜宇轩", score:40, comment:"有点吃力，希望再努力！" },
      { name:"杨演文", score:40, comment:"有点吃力，希望再努力！" },
    ]
  },
  {
    id:4, course:"Python 基础", date:"2025-04-10", teacher:"周", count:3,
    students:[
      { name:"张苏斌", score:41, comment:"再接再厉" },
      { name:"李易萱", score:20, comment:"基础不牢" },
      { name:"石成烨", score:41, comment:"继续努力" },
    ]
  }
];

const courseList = [
  { id:0, name:"信息安全", start:"2025-11-25", teacher:"阮裕光", hours:"开课", intro:"学习人工智能环境搭建" },
  { id:0, name:"人工智能技术基础", start:"2025-11-20", teacher:"叶小楠", hours:"开课", intro:"学习人工智能环境搭建" },
  { id:1, name:"系统架构师", start:"2025-11-01", teacher:"叶小楠", hours:"开课", intro:"学习人工智能环境搭建" },
  { id:2, name:"前端开发工程师", start:"2025-11-01", teacher:"Hi-Tao", hours:"开课", intro:"学习现代化Web框架" },   
  { id:3, name:"机器人工程师", start:"2025-11-01", teacher:"Xiang", hours:"开课", intro:"学习ROS机器人控制技术" },
  { id:4, name:"算法软件工程师", start:"2025-11-01", teacher:"不要@我", hours:"开课", intro:"学习Python算法设计" },
  { id:5, name:"大数据环境搭建", start:"2024-06-01", teacher:"叶小楠", hours:"闭课", intro:"学习大数据技术站环境搭建" },
  { id:6, name:"Python程序设计", start:"2024-06-01", teacher:"Hi-Tao", hours:"闭课", intro:"学习Python编程语言设计" },     
  { id:7, name:"ECharts可视化设计", start:"2024-06-01", teacher:"Xiang", hours:"闭课", intro:"学习图表库的使用与编写" },     
  { id:8, name:"MySQL数据库", start:"2024-06-20", teacher:"不要@我", hours:"闭课", intro:"MySQL基础教程" }
];

/* ===========================
   2. UI LOGIC (Enhanced)
   =========================== */
let isDark = false;

function toggleTheme() {
  isDark = !isDark;
  document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
  const icon = document.getElementById('themeIcon');
  icon.className = isDark ? 'ri-moon-line' : 'ri-sun-line';
  
  // Update Charts for Dark Mode
  chartInstances.forEach(chart => {
    const opt = chart.getOption();
    const txtColor = isDark ? '#94a3b8' : '#64748b';
    const axisColor = isDark ? '#334155' : '#e2e8f0';
    
    if(opt.xAxis) {
      opt.xAxis[0].axisLabel.color = txtColor;
      opt.xAxis[0].splitLine = {lineStyle: {color: axisColor, type:'dashed'}};
    }
    if(opt.yAxis) {
      opt.yAxis[0].axisLabel.color = txtColor;
      opt.yAxis[0].splitLine = {lineStyle: {color: axisColor, type:'dashed'}};
    }
    if(opt.legend) opt.legend[0].textStyle = {color: txtColor};
    if(opt.series && opt.series[0].type === 'pie'){
        opt.series[0].label = {color: isDark ? '#f1f5f9' : '#1e293b'};
    }
    if(opt.series && opt.series[0].type === 'gauge'){
       opt.series[0].detail = {color: isDark ? '#f1f5f9' : '#1e293b'};
    }
    chart.setOption(opt);
  });
}

function toggleFullScreen() {
  if (!document.fullscreenElement) {
    document.documentElement.requestFullscreen();
  } else {
    if (document.exitFullscreen) {
      document.exitFullscreen();
    }
  }
}

function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('mobile-open');
}

function switchView(viewId, el, title) {
  document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
  el.classList.add('active');
  document.querySelectorAll('.view-section').forEach(v => v.style.display = 'none');
  
  const target = document.getElementById(viewId);
  target.style.display = 'block';
  target.classList.remove('fade-in');
  void target.offsetWidth; 
  target.classList.add('fade-in');
  
  document.getElementById('pageTitle').innerText = title;
  
  // Close mobile menu if open
  document.getElementById('sidebar').classList.remove('mobile-open');

  if(viewId === 'dashboard') {
    setTimeout(resizeAllCharts, 100);
  }
}

// Global Toast Notification
function showToast(msg, type='success') {
  const t = document.getElementById('toast');
  t.innerHTML = `<i class="${type==='success'?'ri-checkbox-circle-fill':'ri-information-fill'}"></i> <span>${msg}</span>`;
  t.className = `toast toast-${type} show`;
  setTimeout(()=> t.classList.remove('show'), 3000);
}

function logoutSystem() {
  showToast('正在安全退出...', 'info');
  setTimeout(() => {
    alert('已安全退出系统');
    // window.location.reload(); 实际逻辑可重定向
  }, 1000);
}

function toggleNotifications() { 
  document.getElementById('userDropdown').classList.remove('show');
  document.getElementById('notificationDropdown').classList.toggle('show'); 
}

function toggleUserDropdown(e) {
  if(e) e.stopPropagation();
  document.getElementById('notificationDropdown').classList.remove('show');
  document.getElementById('userDropdown').classList.toggle('show');
}

document.addEventListener('click', function(e) {
  const d = document.getElementById('notificationDropdown');
  const u = document.getElementById('userDropdown');
  if(!e.target.closest('.icon-btn') && !d.contains(e.target)) d.classList.remove('show');
  if(!e.target.closest('.user-profile') && !u.contains(e.target)) u.classList.remove('show');
});

/* ===========================
   3. RENDER FUNCTIONS
   =========================== */
function renderStudents(list=students){
  document.getElementById('studentTable').innerHTML = list.map(s=>`
    <tr>
      <td style="font-weight:600"><i class="ri-user-line" style="color:var(--primary);margin-right:6px"></i>${s.name}</td>
      <td>${s.cls}</td>
      <td>${s.major.replace('人工智能-', '')}</td>
      <td><span class="badge-tag tag-blue">${s.grade}</span></td>
      <td style="font-weight:600;color:${s.scores[0]>=60?'var(--success)':(s.scores[0]===0?'var(--text-muted)':'var(--danger)')}">${s.scores[0]} 分</td>
      <td><button class="btn btn-outline" style="padding:4px 10px; font-size:12px" onclick="openStudentDetail(${s.id})">档案</button></td>
    </tr>
  `).join('');
  document.getElementById('stdCount').innerText = list.length;
}

function applyStudentFilter(){
  const q = document.getElementById('studentSearch').value.trim().toLowerCase();
  const sort = document.getElementById('studentSort').value;
  const status = document.getElementById('studentStatus').value;

  let res = q ? students.filter(s=>s.name.includes(q)||s.cls.includes(q)) : [...students];
  
  // Apply Status
  if (status === 'pass') res = res.filter(s => s.scores[0] >= 60);
  if (status === 'fail') res = res.filter(s => s.scores[0] < 60 && s.scores[0] > 0);

  // Apply Sort
  if (sort === 'scoreDesc') res.sort((a,b) => b.scores[0] - a.scores[0]);
  if (sort === 'scoreAsc') res.sort((a,b) => a.scores[0] - b.scores[0]);

  renderStudents(res);
}

function resetStudentFilter(){ 
  document.getElementById('studentSearch').value=''; 
  document.getElementById('studentSort').value='default';
  document.getElementById('studentStatus').value='all';
  renderStudents(); 
}

// NEW: Export Function
function exportToCSV() {
  let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
  csvContent += "ID,姓名,国籍,专业,年级,性别,分数,电话,直系导师\n";
  
  students.forEach(s => {
    let row = `${s.id},${s.name},${s.cls},${s.major},${s.grade},${s.gender},${s.scores[0]},${s.phone},${s.email}`;
    csvContent += row + "\r\n";
  });

  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", "student_data_export.csv");
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  showToast("CSV 数据导出成功");
}

function openStudentDetail(id){
  const s = students.find(x=>x.id===id); if(!s) return;
  document.getElementById('studentModalTitle').innerText = s.name + ' · 学生档案';
  document.getElementById('studentModalBody').innerHTML = `
    <div style="display:flex; gap:32px; flex-wrap:wrap">
      <div style="flex:1; min-width:200px">
         <p><strong>国籍：</strong>${s.cls}</p>
         <p><strong>专业：</strong>${s.major}</p>
         <p><strong>年级：</strong>${s.grade}</p>
         <p><strong>入学时间：</strong>${s.age}</p>
      </div>
      <div style="flex:1; min-width:200px">
         <p><strong>性别：</strong>${s.gender}</p>
         <p><strong>电话：</strong>${s.phone}</p>
         <p><strong>直系导师：</strong>${s.email}</p>
         <p><strong>最近成绩：</strong><span style="color:var(--primary);font-weight:bold">${s.scores[0]}</span></p>
         <p><strong>宗教信仰：</strong>${s.religion}</p>
      </div>
    </div>`;
  document.getElementById('studentModal').classList.add('show');
}
function closeStudentModal(){ document.getElementById('studentModal').classList.remove('show'); }

function renderTeachers(){
  const q = document.getElementById('teacherSearch').value.trim().toLowerCase();
  const list = q ? teachers.filter(t=>t.name.includes(q)||t.dept.includes(q)) : teachers;
  document.getElementById('teacherTable').innerHTML = list.map(t=>`
    <tr>
      <td style="font-weight:600">${t.name}</td><td>${t.years}岁</td>
      <td><span style="font-size:12px;color:var(--text-muted)">${t.course}</span></td>
      <td>${t.dept}</td>
      <td><button class="btn btn-outline" style="padding:4px 10px; font-size:12px" onclick="showToast('已发送邮件至 ${t.email}')">联系</button></td>
    </tr>`).join('');
}

function renderExams(){
  const q = document.getElementById('examSearch').value.trim().toLowerCase();
  const list = q ? exams.filter(e=>e.name.includes(q)) : exams;
  document.getElementById('examTable').innerHTML = list.map(e=>`
    <tr><td style="font-weight:600">${e.name}</td><td>${e.subject}</td><td>${e.time}</td><td>${e.num}人</td><td>${e.pass}</td></tr>`).join('');
}

function renderExamInfo(){
  const q = document.getElementById('examInfoSearch').value.trim().toLowerCase();
  const list = q ? examInfoList.filter(e=>e.course.includes(q)||e.teacher.includes(q)) : examInfoList;
  document.getElementById('examInfoTable').innerHTML = list.map(e=>`
    <tr>
      <td style="font-weight:600">${e.course}</td><td>${e.date}</td><td>${e.teacher}</td>
      <td><span class="badge-tag tag-gray">${e.count} 人参考</span></td>
      <td><button class="btn btn-outline" style="padding:4px 10px; font-size:12px" onclick="openExamDetail(${e.id})">成绩单</button></td>
    </tr>`).join('');
}

function openExamDetail(id){
  const e = examInfoList.find(x=>x.id===id); if(!e) return;
  document.getElementById('examModalTitle').innerText = e.course + ' · 成绩单';
  document.getElementById('examModalTable').innerHTML = e.students.map(s=>`
    <tr>
      <td style="padding:12px">${s.name}</td>
      <td style="padding:12px; font-weight:600; color:${s.score>=60?'var(--success)':'var(--danger)'}">${s.score}</td>
      <td style="padding:12px; font-size:13px; color:var(--text-muted)">${s.comment}</td>
    </tr>`).join('');
  document.getElementById('examModal').classList.add('show');
}
function closeExamModal(){ document.getElementById('examModal').classList.remove('show'); }

function renderCourses(){
  const q = document.getElementById('courseSearch').value.trim().toLowerCase();
  const list = q ? courseList.filter(c=>c.name.includes(q)) : courseList;
  document.getElementById('courseTable').innerHTML = list.map(c=>`
    <tr>
      <td style="font-weight:600">${c.name}</td><td>${c.start}</td><td>${c.teacher}</td>
      <td><span class="badge-tag ${c.hours==='开课'?'tag-green':'tag-gray'}">${c.hours}</span></td>
      <td><button class="btn btn-outline" style="padding:4px 10px; font-size:12px">大纲</button></td>
    </tr>`).join('');
}
function modalOverlayClick(e,id){ if(e.target.id===id) document.getElementById(id).classList.remove('show'); }

/* ===========================
   4. DASHBOARD & CHARTS
   =========================== */
let chartInstances = [];

function calcStats(){
  document.getElementById('totalStudents').innerText = students.length;
  document.getElementById('totalCourses').innerText = courseList.filter(c=>c.hours==='开课').length;
  document.getElementById('totalExams').innerText = exams.length;
  
  const validScores = students.flatMap(s=>s.scores).filter(s=>s>0);
  const avg = validScores.length ? Math.round(validScores.reduce((a,b)=>a+b,0)/validScores.length) : 0;
  document.getElementById('avgScore').innerText = avg + "分";

  // NEW: Render Honor Roll
  const topStudents = [...students].sort((a,b) => b.scores[0] - a.scores[0]).slice(0,5);
  document.getElementById('honorList').innerHTML = topStudents.map((s, idx) => `
    <div class="honor-item">
      <div class="rank-badge rank-${idx+1}">${idx+1}</div>
      <div class="honor-info">
        <div style="font-weight:600; font-size:13px">${s.name}</div>
        <div style="font-size:11px; color:var(--text-muted)">${s.major.split('-')[1] || s.major}</div>
      </div>
      <div class="honor-score">${s.scores[0]}</div>
    </div>
  `).join('');
}

function initCharts(){
  const commonGrid = {left:10, right:20, bottom:10, top:40, containLabel:true};
  
  // 1. Gender Pie
  const chartGender = echarts.init(document.getElementById('chartGender'));
  chartGender.setOption({
    color: ['#3b82f6', '#f43f5e'],
    tooltip: {trigger:'item'},
    series: [{
      type:'pie', radius:['45%','70%'], center:['50%','50%'],
      itemStyle: {borderRadius:8, borderColor:'transparent', borderWidth:2},
      label: {show:true, formatter:'{b}\n{c}人', color: '#64748b'},
      data: [
        {value:students.filter(s=>s.gender==='男').length, name:'男'},
        {value:students.filter(s=>s.gender==='女').length, name:'女'}
      ]
    }]
  });
  chartInstances.push(chartGender);

  // 2. Major Rose Chart
  const chartMajor = echarts.init(document.getElementById('chartMajor'));
  const majorMap = {};
  students.forEach(s=> { const m = s.major.replace('人工智能-',''); majorMap[m] = (majorMap[m]||0)+1; });
  const majorData = Object.keys(majorMap).map(k=>({value:majorMap[k], name:k}));
  chartMajor.setOption({
    color: ['#3b82f6', '#8b5cf6', '#10b981', '#f59e0b'],
    tooltip: {trigger:'item'},
    series: [{
      type:'pie', radius:[20,100], center:['50%','55%'], roseType:'area',
      itemStyle: {borderRadius:6},
      label: {color: '#64748b'},
      data: majorData
    }]
  });
  chartInstances.push(chartMajor);

  // 3. Score Bar
  const chartScore = echarts.init(document.getElementById('chartScore'));
  const names = students.map(s=>s.name);
  const scs = students.map(s=>s.scores[0]);
  chartScore.setOption({
    color: ['#3b82f6'], tooltip:{trigger:'axis'}, grid: commonGrid,
    xAxis: {type:'category', data:names, axisLabel:{interval:0, rotate:45, fontSize:10, color:'#64748b'}, axisTick:{show:false}, axisLine:{show:false}},
    yAxis: {type:'value', splitLine:{lineStyle:{type:'dashed', color:'#e2e8f0'}}, axisLabel:{color:'#64748b'}},
    series: [{type:'bar', data:scs, barMaxWidth:20, itemStyle:{borderRadius:[4,4,0,0]}}]
  });
  chartInstances.push(chartScore);

  // 4. Pass Rate Gauge
  const chartPassRate = echarts.init(document.getElementById('chartPassRate'));
  const passCount = students.filter(s=>s.scores[0]>=60).length;
  const passRate = Math.round((passCount/students.length)*100);
  chartPassRate.setOption({
    series: [{
      type:'gauge', startAngle:180, endAngle:0, min:0, max:100,
      splitNumber:5, itemStyle:{color:'#10b981'},
      progress:{show:true, width:12}, pointer:{show:false},
      axisLine:{lineStyle:{width:12, color:[[1,'rgba(125,125,125,0.1)']]}},
      axisTick:{show:false}, splitLine:{show:false}, axisLabel:{show:false},
      detail: {valueAnimation:true, fontSize:30, fontWeight:'bold', color:'#1e293b', formatter:'{value}%', offsetCenter:[0,'-10%']},
      data: [{value:passRate, name:'及格率'}]
    }]
  });
  chartInstances.push(chartPassRate);

  // 5. Grade Line
  const chartGrade = echarts.init(document.getElementById('chartGrade'));
  const grades = [...new Set(students.map(s=>s.grade))].sort();
  const gData = grades.map(g=>students.filter(s=>s.grade===g).length);
  chartGrade.setOption({
    color: ['#8b5cf6'], tooltip:{trigger:'axis'}, grid: commonGrid,
    xAxis: {type:'category', data:grades, axisTick:{show:false}, axisLine:{show:false}, axisLabel:{color:'#64748b'}},
    yAxis: {type:'value', splitLine:{lineStyle:{type:'dashed', color:'#e2e8f0'}}, axisLabel:{color:'#64748b'}},
    series: [{type:'line', data:gData, smooth:true, areaStyle:{opacity:0.2}, symbolSize:8}]
  });
  chartInstances.push(chartGrade);

  // 6. Teacher Load Bar
  const chartTeacherLoad = echarts.init(document.getElementById('chartTeacherLoad'));
  const tMap = {};
  courseList.forEach(c => { tMap[c.teacher] = (tMap[c.teacher]||0) + 1; });
  const tNames = Object.keys(tMap);
  const tVals = Object.values(tMap);
  chartTeacherLoad.setOption({
    color: ['#f59e0b'], tooltip:{trigger:'axis'}, grid: commonGrid,
    xAxis: {type:'value', splitLine:{show:false}, axisLabel:{color:'#64748b'}},
    yAxis: {type:'category', data:tNames, axisTick:{show:false}, axisLine:{show:false}, axisLabel:{color:'#64748b'}},
    series: [{type:'bar', data:tVals, barMaxWidth:16, itemStyle:{borderRadius:[0,4,4,0]}, label:{show:true, position:'right', formatter:'{c}门', color:'#64748b'}}]
  });
  chartInstances.push(chartTeacherLoad);

  // 7. NEW: Course Status Pie
  const chartCourseStatus = echarts.init(document.getElementById('chartCourseStatus'));
  const openC = courseList.filter(c=>c.hours==='开课').length;
  const closedC = courseList.filter(c=>c.hours==='闭课').length;
  chartCourseStatus.setOption({
    color: ['#10b981', '#64748b'], tooltip:{trigger:'item'},
    series: [{
      type:'pie', radius:['50%','70%'], center:['50%','50%'],
      label: {show:true, formatter:'{b}: {c}', color:'#64748b'},
      data: [{value:openC, name:'进行中'}, {value:closedC, name:'已结课'}]
    }]
  });
  chartInstances.push(chartCourseStatus);
}

function resizeAllCharts(){ chartInstances.forEach(c => c.resize()); }
window.addEventListener('resize', resizeAllCharts);

function init(){
  calcStats();
  renderStudents();
  renderTeachers();
  renderExams();
  renderExamInfo();
  renderCourses();
  initCharts();
}
init();
</script>
</body>
</html>